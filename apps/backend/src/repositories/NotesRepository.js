"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotesRepository = void 0;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
class NotesRepository {
    constructor(client) {
        const dynamoClient = client || new client_dynamodb_1.DynamoDBClient({});
        this.docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(dynamoClient);
    }
    buildPK(userId) {
        return `${NotesRepository.PK_PREFIX}${userId}`;
    }
    buildSK(noteId) {
        return `${NotesRepository.SK_PREFIX}${noteId}`;
    }
    buildGSI_PK(userId) {
        return `${NotesRepository.PK_PREFIX}${userId}`;
    }
    buildGSI_SK(updatedAt, noteId) {
        return `${updatedAt}#${noteId}`;
    }
    itemToNote(item) {
        return {
            id: item.id,
            userId: item.userId,
            title: item.title,
            content: item.content,
            createdAt: item.createdAt,
            updatedAt: item.updatedAt,
        };
    }
    async createNote(userId, noteId, title, content) {
        const now = new Date().toISOString();
        const item = {
            PK: this.buildPK(userId),
            SK: this.buildSK(noteId),
            GSI_PK: this.buildGSI_PK(userId),
            GSI_SK: this.buildGSI_SK(now, noteId),
            id: noteId,
            userId,
            title,
            content,
            createdAt: now,
            updatedAt: now,
        };
        await this.docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: NotesRepository.TABLE_NAME,
            Item: item,
        }));
        return this.itemToNote(item);
    }
    async getNote(userId, noteId) {
        const result = await this.docClient.send(new lib_dynamodb_1.GetCommand({
            TableName: NotesRepository.TABLE_NAME,
            Key: {
                PK: this.buildPK(userId),
                SK: this.buildSK(noteId),
            },
        }));
        if (!result.Item) {
            return null;
        }
        return this.itemToNote(result.Item);
    }
    async listNotes(userId) {
        const result = await this.docClient.send(new lib_dynamodb_1.QueryCommand({
            TableName: NotesRepository.TABLE_NAME,
            IndexName: NotesRepository.GSI_NAME,
            KeyConditionExpression: 'GSI_PK = :pk',
            ExpressionAttributeValues: {
                ':pk': this.buildGSI_PK(userId),
            },
            ScanIndexForward: false,
        }));
        return (result.Items || []).map((item) => this.itemToNote(item));
    }
    async updateNote(userId, noteId, updates) {
        const existing = await this.getNote(userId, noteId);
        if (!existing) {
            return null;
        }
        const now = new Date().toISOString();
        const updatedItem = {
            PK: this.buildPK(userId),
            SK: this.buildSK(noteId),
            GSI_PK: this.buildGSI_PK(userId),
            GSI_SK: this.buildGSI_SK(now, noteId),
            id: existing.id,
            userId: existing.userId,
            title: updates.title !== undefined ? updates.title : existing.title,
            content: updates.content !== undefined ? updates.content : existing.content,
            createdAt: existing.createdAt,
            updatedAt: now,
        };
        await this.docClient.send(new lib_dynamodb_1.PutCommand({
            TableName: NotesRepository.TABLE_NAME,
            Item: updatedItem,
        }));
        return this.itemToNote(updatedItem);
    }
    async deleteNote(userId, noteId) {
        await this.docClient.send(new lib_dynamodb_1.DeleteCommand({
            TableName: NotesRepository.TABLE_NAME,
            Key: {
                PK: this.buildPK(userId),
                SK: this.buildSK(noteId),
            },
        }));
    }
}
exports.NotesRepository = NotesRepository;
NotesRepository.TABLE_NAME = process.env.TABLE_NAME;
NotesRepository.PK_PREFIX = 'USER#';
NotesRepository.SK_PREFIX = 'NOTE#';
NotesRepository.GSI_NAME = 'ByUpdatedAt';
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm90ZXNSZXBvc2l0b3J5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTm90ZXNSZXBvc2l0b3J5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLDhEQUEwRDtBQUMxRCx3REFNK0I7QUF3Qi9CLE1BQWEsZUFBZTtJQVExQixZQUFZLE1BQXVCO1FBQ2pDLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxJQUFJLGdDQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLFNBQVMsR0FBRyxxQ0FBc0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDN0QsQ0FBQztJQUVPLE9BQU8sQ0FBQyxNQUFjO1FBQzVCLE9BQU8sR0FBRyxlQUFlLENBQUMsU0FBUyxHQUFHLE1BQU0sRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFFTyxPQUFPLENBQUMsTUFBYztRQUM1QixPQUFPLEdBQUcsZUFBZSxDQUFDLFNBQVMsR0FBRyxNQUFNLEVBQUUsQ0FBQztJQUNqRCxDQUFDO0lBRU8sV0FBVyxDQUFDLE1BQWM7UUFDaEMsT0FBTyxHQUFHLGVBQWUsQ0FBQyxTQUFTLEdBQUcsTUFBTSxFQUFFLENBQUM7SUFDakQsQ0FBQztJQUVPLFdBQVcsQ0FBQyxTQUFpQixFQUFFLE1BQWM7UUFDbkQsT0FBTyxHQUFHLFNBQVMsSUFBSSxNQUFNLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRU8sVUFBVSxDQUFDLElBQWM7UUFDL0IsT0FBTztZQUNMLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtZQUNYLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtZQUNuQixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3JCLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUztZQUN6QixTQUFTLEVBQUUsSUFBSSxDQUFDLFNBQVM7U0FDMUIsQ0FBQztJQUNKLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUNk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eUIsMEJBQVUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVcsQ0FBQztBQUNyQyx5QkFBUyxHQUFHLE9BQU8sQ0FBQztBQUNwQix5QkFBUyxHQUFHLE9BQU8sQ0FBQztBQUNwQix3QkFBUSxHQUFHLGFBQWEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFB1dENvbW1hbmQsXG4gIEdldENvbW1hbmQsXG4gIFF1ZXJ5Q29tbWFuZCxcbiAgRGVsZXRlQ29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcblxuZXhwb3J0IGludGVyZmFjZSBOb3RlSXRlbSB7XG4gIFBLOiBzdHJpbmc7XG4gIFNLOiBzdHJpbmc7XG4gIEdTSV9QSzogc3RyaW5nO1xuICBHU0lfU0s6IHN0cmluZztcbiAgaWQ6IHN0cmluZztcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gIHVwZGF0ZWRBdDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIE5vdGVEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIGNvbnRlbnQ6IHN0cmluZztcbiAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gIHVwZGF0ZWRBdDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgTm90ZXNSZXBvc2l0b3J5IHtcbiAgcHJpdmF0ZSBzdGF0aWMgcmVhZG9ubHkgVEFCTEVfTkFNRSA9IHByb2Nlc3MuZW52LlRBQkxFX05BTUUhO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBQS19QUkVGSVggPSAnVVNFUiMnO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBTS19QUkVGSVggPSAnTk9URSMnO1xuICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBHU0lfTkFNRSA9ICdCeVVwZGF0ZWRBdCc7XG5cbiAgcHJpdmF0ZSBkb2NDbGllbnQ6IER5bmFtb0RCRG9jdW1lbnRDbGllbnQ7XG5cbiAgY29uc3RydWN0b3IoY2xpZW50PzogRHluYW1vREJDbGllbnQpIHtcbiAgICBjb25zdCBkeW5hbW9DbGllbnQgPSBjbGllbnQgfHwgbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcbiAgICB0aGlzLmRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShkeW5hbW9DbGllbnQpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFBLKHVzZXJJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7Tm90ZXNSZXBvc2l0b3J5LlBLX1BSRUZJWH0ke3VzZXJJZH1gO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFNLKG5vdGVJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7Tm90ZXNSZXBvc2l0b3J5LlNLX1BSRUZJWH0ke25vdGVJZH1gO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEdTSV9QSyh1c2VySWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke05vdGVzUmVwb3NpdG9yeS5QS19QUkVGSVh9JHt1c2VySWR9YDtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRHU0lfU0sodXBkYXRlZEF0OiBzdHJpbmcsIG5vdGVJZDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dXBkYXRlZEF0fSMke25vdGVJZH1gO1xuICB9XG5cbiAgcHJpdmF0ZSBpdGVtVG9Ob3RlKGl0ZW06IE5vdGVJdGVtKTogTm90ZURhdGEge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogaXRlbS5pZCxcbiAgICAgIHVzZXJJZDogaXRlbS51c2VySWQsXG4gICAgICB0aXRsZTogaXRlbS50aXRsZSxcbiAgICAgIGNvbnRlbnQ6IGl0ZW0uY29udGVudCxcbiAgICAgIGNyZWF0ZWRBdDogaXRlbS5jcmVhdGVkQXQsXG4gICAgICB1cGRhdGVkQXQ6IGl0ZW0udXBkYXRlZEF0LFxuICAgIH07XG4gIH1cblxuICBhc3luYyBjcmVhdGVOb3RlKFxuICAgIHVzZXJJZDogc3RyaW5nLFxuICAgIG5vdGVJZDogc3RyaW5nLFxuICAgIHRpdGxlOiBzdHJpbmcsXG4gICAgY29udGVudDogc3RyaW5nXG4gICk6IFByb21pc2U8Tm90ZURhdGE+IHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG5cbiAgICBjb25zdCBpdGVtOiBOb3RlSXRlbSA9IHtcbiAgICAgIFBLOiB0aGlzLmJ1aWxkUEsodXNlcklkKSxcbiAgICAgIFNLOiB0aGlzLmJ1aWxkU0sobm90ZUlkKSxcbiAgICAgIEdTSV9QSzogdGhpcy5idWlsZEdTSV9QSyh1c2VySWQpLFxuICAgICAgR1NJX1NLOiB0aGlzLmJ1aWxkR1NJX1NLKG5vdywgbm90ZUlkKSxcbiAgICAgIGlkOiBub3RlSWQsXG4gICAgICB1c2VySWQsXG4gICAgICB0aXRsZSxcbiAgICAgIGNvbnRlbnQsXG4gICAgICBjcmVhdGVkQXQ6IG5vdyxcbiAgICAgIHVwZGF0ZWRBdDogbm93LFxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFB1dENvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IE5vdGVzUmVwb3NpdG9yeS5UQUJMRV9OQU1FLFxuICAgICAgICBJdGVtOiBpdGVtLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMuaXRlbVRvTm90ZShpdGVtKTtcbiAgfVxuXG4gIGFzeW5jIGdldE5vdGUodXNlcklkOiBzdHJpbmcsIG5vdGVJZDogc3RyaW5nKTogUHJvbWlzZTxOb3RlRGF0YSB8IG51bGw+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEdldENvbW1hbmQoe1xuICAgICAgICBUYWJsZU5hbWU6IE5vdGVzUmVwb3NpdG9yeS5UQUJMRV9OQU1FLFxuICAgICAgICBLZXk6IHtcbiAgICAgICAgICBQSzogdGhpcy5idWlsZFBLKHVzZXJJZCksXG4gICAgICAgICAgU0s6IHRoaXMuYnVpbGRTSyhub3RlSWQpLFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgaWYgKCFyZXN1bHQuSXRlbSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuaXRlbVRvTm90ZShyZXN1bHQuSXRlbSBhcyBOb3RlSXRlbSk7XG4gIH1cblxuICBhc3luYyBsaXN0Tm90ZXModXNlcklkOiBzdHJpbmcpOiBQcm9taXNlPE5vdGVEYXRhW10+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFF1ZXJ5Q29tbWFuZCh7XG4gICAgICAgIFRhYmxlTmFtZTogTm90ZXNSZXBvc2l0b3J5LlRBQkxFX05BTUUsXG4gICAgICAgIEluZGV4TmFtZTogTm90ZXNSZXBvc2l0b3J5LkdTSV9OQU1FLFxuICAgICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiAnR1NJX1BLID0gOnBrJyxcbiAgICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczoge1xuICAgICAgICAgICc6cGsnOiB0aGlzLmJ1aWxkR1NJX1BLKHVzZXJJZCksXG4gICAgICAgIH0sXG4gICAgICAgIFNjYW5JbmRleEZvcndhcmQ6IGZhbHNlLFxuICAgICAgfSlcbiAgICApO1xuXG4gICAgcmV0dXJuIChyZXN1bHQuSXRlbXMgfHwgW10pLm1hcCgoaXRlbSkgPT4gdGhpcy5pdGVtVG9Ob3RlKGl0ZW0gYXMgTm90ZUl0ZW0pKTtcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZU5vdGUoXG4gICAgdXNlcklkOiBzdHJpbmcsXG4gICAgbm90ZUlkOiBzdHJpbmcsXG4gICAgdXBkYXRlczogeyB0aXRsZT86IHN0cmluZzsgY29udGVudD86IHN0cmluZyB9XG4gICk6IFByb21pc2U8Tm90ZURhdGEgfCBudWxsPiB7XG4gICAgY29uc3QgZXhpc3RpbmcgPSBhd2FpdCB0aGlzLmdldE5vdGUodXNlcklkLCBub3RlSWQpO1xuXG4gICAgaWYgKCFleGlzdGluZykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgbm93ID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuXG4gICAgY29uc3QgdXBkYXRlZEl0ZW06IE5vdGVJdGVtID0ge1xuICAgICAgUEs6IHRoaXMuYnVpbGRQSyh1c2VySWQpLFxuICAgICAgU0s6IHRoaXMuYnVpbGRTSyhub3RlSWQpLFxuICAgICAgR1NJX1BLOiB0aGlzLmJ1aWxkR1NJX1BLKHVzZXJJZCksXG4gICAgICBHU0lfU0s6IHRoaXMuYnVpbGRHU0lfU0sobm93LCBub3RlSWQpLFxuICAgICAgaWQ6IGV4aXN0aW5nLmlkLFxuICAgICAgdXNlcklkOiBleGlzdGluZy51c2VySWQsXG4gICAgICB0aXRsZTogdXBkYXRlcy50aXRsZSAhPT0gdW5kZWZpbmVkID8gdXBkYXRlcy50aXRsZSA6IGV4aXN0aW5nLnRpdGxlLFxuICAgICAgY29udGVudDogdXBkYXRlcy5jb250ZW50ICE9PSB1bmRlZmluZWQgPyB1cGRhdGVzLmNvbnRlbnQgOiBleGlzdGluZy5jb250ZW50LFxuICAgICAgY3JlYXRlZEF0OiBleGlzdGluZy5jcmVhdGVkQXQsXG4gICAgICB1cGRhdGVkQXQ6IG5vdyxcbiAgICB9O1xuXG4gICAgYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBQdXRDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBOb3Rlc1JlcG9zaXRvcnkuVEFCTEVfTkFNRSxcbiAgICAgICAgSXRlbTogdXBkYXRlZEl0ZW0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5pdGVtVG9Ob3RlKHVwZGF0ZWRJdGVtKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZU5vdGUodXNlcklkOiBzdHJpbmcsIG5vdGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5kb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBEZWxldGVDb21tYW5kKHtcbiAgICAgICAgVGFibGVOYW1lOiBOb3Rlc1JlcG9zaXRvcnkuVEFCTEVfTkFNRSxcbiAgICAgICAgS2V5OiB7XG4gICAgICAgICAgUEs6IHRoaXMuYnVpbGRQSyh1c2VySWQpLFxuICAgICAgICAgIFNLOiB0aGlzLmJ1aWxkU0sobm90ZUlkKSxcbiAgICAgICAgfSxcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxufVxuIl19